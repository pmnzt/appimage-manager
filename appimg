#!/usr/bin/env bash

# ============================================================
# appimg - AppImage manager tool
# Commands:
#   appimg ls
#   appimg move [--all] [-s dir] [file.AppImage]
#   appimg update
#   appimg setup-all
#   appimg reset
# ============================================================

APPIMG_DIR="$HOME/.appimages"
DESKTOP_TARGET="$HOME/.local/share/applications"

# Ensure ~/.local/share/applications exists
mkdir -p "$DESKTOP_TARGET"


# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------
die() {
    echo "Error: $1" >&2
    exit 1
}

find_appimages() {
    local search_dir="$1"
    find "$search_dir" -type f -iname "*.AppImage" 2>/dev/null
}

appname_from_path() {
    basename "$1" | sed 's/.AppImage$//'
}


# ------------------------------------------------------------
# Command: appimg ls
# ------------------------------------------------------------
cmd_ls() {
    local search="$HOME"
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s) search="$2"; shift 2 ;;
            *) die "Unknown option for ls: $1" ;;
        esac
    done

    find_appimages "$search"
}


# ------------------------------------------------------------
# Command: appimg move
# ------------------------------------------------------------
cmd_move() {
    local search="$HOME"
    local do_all=0
    local specific_file=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s) search="$2"; shift 2 ;;
            --all) do_all=1; shift ;;
            *) specific_file="$1"; shift ;;
        esac
    done

    mkdir -p "$APPIMG_DIR"

    # Function to get base name (without .AppImage or .appimage)
    get_base_name() {
        local file="$1"
        local fname
        fname=$(basename "$file")
        echo "${fname%.[Aa][Pp][Pp][Ii][Mm][Aa][Gg][Ee]}"
    }

    # Function to move icons from tmp associated with a given app
    move_tmp_icons() {
        local app_name="$1"
        local dest="$APPIMG_DIR/$app_name"
        shopt -s nullglob
        for icon in "$APPIMG_DIR/tmp/$app_name-icon."*; do
            [[ -f "$icon" ]] || continue
            ext="${icon##*.}"
            echo "Moving icon $(basename "$icon") → $dest/icon.$ext"
            mv "$icon" "$dest/icon.$ext"
        done
        shopt -u nullglob
    }

    # Move ALL AppImages
    if [[ "$do_all" -eq 1 ]]; then
        mapfile -t files < <(find_appimages "$search")
        [[ ${#files[@]} -eq 0 ]] && die "No AppImages found."

        for f in "${files[@]}"; do
            # Skip all files inside ~/.appimages except tmp/
            if [[ "$f" == "$APPIMG_DIR"* && "$f" != "$APPIMG_DIR/tmp"* ]]; then
                echo "Skipping (already managed): $f"
                continue
            fi

            filename=$(basename "$f")
            name=$(get_base_name "$f")
            dest="$APPIMG_DIR/$name"
            mkdir -p "$dest"
            echo "Moving $f → $dest/$filename"
            mv "$f" "$dest/$filename" || die "Failed to move $f"

            # Move associated icons from tmp if they exist
            if [[ "$f" == "$APPIMG_DIR/tmp"* ]]; then
                move_tmp_icons "$name"
            fi
        done
        return
    fi

    # Single file mode
    if [[ -z "$specific_file" ]]; then
        die "You must provide a file unless using --all"
    fi

    # Skip if file is already managed, except tmp
    if [[ "$specific_file" == "$APPIMG_DIR"* && "$specific_file" != "$APPIMG_DIR/tmp"* ]]; then
        echo "Skipping (already in appimages): $specific_file"
        exit 0
    fi

    if [[ ! -f "$specific_file" ]]; then
        die "File not found: $specific_file"
    fi

    filename=$(basename "$specific_file")
    name=$(get_base_name "$specific_file")
    dest="$APPIMG_DIR/$name"
    mkdir -p "$dest"
    echo "Moving $specific_file → $dest/$filename"
    mv "$specific_file" "$dest/$filename" || die "Failed to move file"

    # Move associated icons from tmp if present, rename back to icon.*
    if [[ "$specific_file" == "$APPIMG_DIR/tmp"* ]]; then
        move_tmp_icons "$name"
    fi
}

# ------------------------------------------------------------
# Command: appimg update
# ------------------------------------------------------------
cmd_update() {
    [[ ! -d "$APPIMG_DIR" ]] && die "$APPIMG_DIR does not exist."

    for dir in "$APPIMG_DIR"/*; do
        [[ ! -d "$dir" ]] && continue

        # Find the first AppImage file (case-insensitive)
        appimage=$(find "$dir" -maxdepth 1 -type f -iname "*.AppImage" | head -n 1)
        [[ -z "$appimage" ]] && continue

        # Make sure the AppImage is executable
        chmod +x "$appimage"

        # Get base name (strip extension, case-insensitive)
        filename=$(basename "$appimage")
        name="${filename%.[Aa][Pp][Pp][Ii][Mm][Aa][Gg][Ee]}"

        desktop_file="$dir/$name.desktop"

        # Icon detection (case-insensitive). Prefer an icon file in the folder.
        icon=$(find "$dir" -maxdepth 1 -type f -iname "icon.*" | head -n 1)
        if [[ -z "$icon" ]]; then
            # Try to extract the AppImage and look for embedded icons.
            tmpdir=$(mktemp -d)
            # Some AppImages support --appimage-extract; ignore failures.
            (cd "$tmpdir" && "$appimage" --appimage-extract >/dev/null 2>&1) || true

            if [[ -d "$tmpdir/squashfs-root" ]]; then
                # Search for common icon file types inside the extracted content.
                icon_candidate=$(find "$tmpdir/squashfs-root" -type f \( -iname '*.png' -o -iname '*.svg' -o -iname '*.xpm' \) -not -iname '*thumbnail*' | head -n 1)
                if [[ -n "$icon_candidate" ]]; then
                    ext="${icon_candidate##*.}"
                    # Copy the found icon into the app folder as icon.<ext>
                    cp "$icon_candidate" "$dir/icon.$ext" 2>/dev/null || true
                    icon="$dir/icon.$ext"
                else
                    icon="$APPIMG_DIR/placeholder-icon.png"
                fi
            else
                icon="$APPIMG_DIR/placeholder-icon.png"
            fi

            rm -rf "$tmpdir"
        fi

        echo "Generating $desktop_file"

        cat > "$desktop_file" <<EOF
[Desktop Entry]
Type=Application
Name=$name
Exec="$appimage"
Icon=$icon
Terminal=false
Categories=Utility;
EOF

        chmod +x "$desktop_file"

        # Symlink into applications directory
        ln -sf "$desktop_file" "$DESKTOP_TARGET/$name.desktop"
        echo "Linked → $DESKTOP_TARGET/$name.desktop"
    done
}


# ------------------------------------------------------------
# Command: appimg setup-all
# ------------------------------------------------------------
cmd_setup_all() {
    cmd_move --all
    cmd_update
}


# ------------------------------------------------------------
# Command: appimg reset
# ------------------------------------------------------------
cmd_reset() {
    echo "Resetting AppImage structure..."

    # ---------------------------------------------
    # 1. Remove all .desktop symlinks pointing to ~/.appimages
    # ---------------------------------------------
    echo "Removing AppImage desktop entry symlinks..."
    find "$DESKTOP_TARGET" -type l | while IFS= read -r link; do
        target="$(readlink -f "$link")"
        if [[ "$target" == "$APPIMG_DIR"* ]]; then
            echo "Deleting symlink: $link"
            rm -f "$link"
        fi
    done

    mkdir -p "$APPIMG_DIR/tmp"

    # ---------------------------------------------
    # 2. Move all AppImage files and their icons into tmp/
    # ---------------------------------------------
    find "$APPIMG_DIR" -mindepth 2 -type f -iname "*.AppImage" | while IFS= read -r f; do
        file_name=$(basename "$f")
        app_dir=$(dirname "$f")
        echo "Moving $f → $APPIMG_DIR/tmp/$file_name"
        mv "$f" "$APPIMG_DIR/tmp/$file_name" || continue

        # Check for any icon in the same folder
        icon=$(find "$app_dir" -maxdepth 1 -type f -iname "icon.*" | head -n 1)
        if [[ -n "$icon" && -f "$icon" ]]; then
            icon_ext="${icon##*.}"
            icon_name="${file_name%.[Aa][Pp][Pp][Ii][Mm][Aa][Gg][Ee]}-icon.$icon_ext"
            echo "Moving icon $icon → $APPIMG_DIR/tmp/$icon_name"
            mv "$icon" "$APPIMG_DIR/tmp/$icon_name" || echo "Failed to move icon $icon"
        fi
    done

    # ---------------------------------------------
    # 3. Delete all folders inside ~/.appimages
    #    except: tmp/ and placeholder-icon.png
    # ---------------------------------------------
    for item in "$APPIMG_DIR"/*; do
        base="$(basename "$item")"
        [[ "$base" == "tmp" ]] && continue
        [[ "$base" == "placeholder-icon.png" ]] && continue
        if [[ -d "$item" ]]; then
            echo "Deleting folder: $item"
            rm -rf "$item"
        fi
    done

    # ---------------------------------------------
    # 4. Remove executable bit from all AppImages in tmp
    # ---------------------------------------------
    echo "Removing executable permissions from AppImages in tmp/"
    shopt -s nullglob
    for f in "$APPIMG_DIR"/tmp/*.AppImage; do
        chmod -x "$f"
    done
    shopt -u nullglob

    echo "Reset complete! Run 'appimg setup-all' to rebuild."
}


# ------------------------------------------------------------
# Dispatcher
# ------------------------------------------------------------
main() {
    case "$1" in
        ls)        shift; cmd_ls "$@" ;;
        move)      shift; cmd_move "$@" ;;
        update)    shift; cmd_update ;;
        setup-all) shift; cmd_setup_all ;;
        reset) shift; cmd_reset ;;
        *)
            echo "AppImage manager"
            echo "Commands:"
            echo "  appimg ls [-s dir]"
            echo "  appimg move [--all] [-s dir] [file.AppImage]"
            echo "  appimg update"
            echo "  appimg setup-all"
            echo "  appimg reset"
            exit 1
            ;;
    esac
}

main "$@"
